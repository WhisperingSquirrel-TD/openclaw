#!/bin/bash
set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

info() { echo -e "${GREEN}[✓] $1${NC}"; }
warn() { echo -e "${YELLOW}[!] $1${NC}"; }
fail() { echo -e "${RED}[✗] $1${NC}"; exit 1; }

echo ""
echo "========================================="
echo "  L1 — Install Forked OpenClaw"
echo "========================================="
echo ""

# Step 1: Stop L1
warn "Stopping L1..."
~/l1-stop.sh 2>/dev/null || true
info "L1 stopped"

# Step 2: Uninstall existing OpenClaw
warn "Uninstalling current OpenClaw..."
sudo npm uninstall -g openclaw 2>/dev/null || true
info "Old OpenClaw removed"

# Step 3: Install pnpm if not present
if ! command -v pnpm &> /dev/null; then
    warn "Installing pnpm..."
    sudo npm install -g pnpm || fail "pnpm install failed"
    info "pnpm installed"
else
    info "pnpm already installed"
fi

# Step 4: Clone or pull the fork
if [ -d ~/openclaw ]; then
    warn "Fork already cloned — pulling latest changes..."
    cd ~/openclaw
    git pull || fail "Git pull failed. Check your connection."
    info "Code updated"
else
    warn "Cloning fork from GitHub..."
    cd ~
    git clone https://github.com/whisperingsquirrel-TD/openclaw.git || fail "Clone failed. Check your connection and repo name."
    cd ~/openclaw
    info "Fork cloned"
fi

# Step 5: Install dependencies with pnpm
warn "Installing dependencies with pnpm (this may take a few minutes on Pi)..."
cd ~/openclaw
pnpm install || fail "pnpm install failed"
info "Dependencies installed"

# Step 6: Build TypeScript
warn "Building from TypeScript source (this may take a while on Pi)..."
pnpm run build || fail "Build failed — check for TypeScript errors"
info "Build complete"

# Step 7: Link globally
warn "Linking openclaw globally..."
sudo npm link || fail "npm link failed"
info "OpenClaw linked — your fork is now the active version"

# Step 8: Verify
if command -v openclaw &> /dev/null; then
    info "OpenClaw available: $(openclaw --version 2>/dev/null || echo 'installed')"
else
    fail "OpenClaw not found after link"
fi

# Step 9: Update config — set WhatsApp to watch mode
echo ""
warn "Updating openclaw.json — setting WhatsApp to watch mode..."

sudo chattr -i ~/.openclaw/openclaw.json 2>/dev/null || true

python3 -c "
import json

with open('/home/tomdean88/.openclaw/openclaw.json', 'r') as f:
    c = json.load(f)

# Set WhatsApp to watch mode — only schema-valid fields
c['channels']['whatsapp'] = {
    'mode': 'watch',
    'dmPolicy': 'open',
    'groupPolicy': 'open',
    'debounceMs': 3000,
    'mediaMaxMb': 50
}

# Make sure Telegram stays active
if 'telegram' not in c['channels']:
    print('WARNING: Telegram config missing — check manually')
else:
    print(f'Telegram config preserved (botToken present: {\"botToken\" in c[\"channels\"][\"telegram\"]})')

# Remove message.send from denyCommands if present (watch mode handles it now)
deny = c.get('gateway', {}).get('nodes', {}).get('denyCommands', [])
if 'message.send' in deny:
    deny.remove('message.send')
    print('Removed message.send from denyCommands — watch mode enforces this now')

# Ensure restart is still disabled
c['commands']['restart'] = False

# Ensure sandbox exec
c['tools']['exec']['host'] = 'sandbox'

with open('/home/tomdean88/.openclaw/openclaw.json', 'w') as f:
    json.dump(c, f, indent=2)

print('Config updated successfully')
"

sudo chattr +i ~/.openclaw/openclaw.json
info "Config updated and locked"

# Step 10: Start L1
echo ""
warn "Starting L1..."
~/l1-start.sh

# Step 11: Update hashes
md5sum /mnt/l1-secure/*.md > ~/l1-hashes.txt 2>/dev/null || true
info "Hashes updated"

echo ""
echo "========================================="
echo "  DONE"
echo "========================================="
echo ""
echo "  Fork installed from: github.com/whisperingsquirrel-TD/openclaw"
echo "  WhatsApp: watch mode (read-only, silent)"
echo "  Telegram: active (2-way with Tom)"
echo "  Config: locked"
echo ""
echo "  To pull future updates:"
echo "    cd ~/openclaw && git pull && pnpm run build && openclaw gateway restart"
echo ""
echo "  To check status:"
echo "    openclaw doctor"
echo ""
